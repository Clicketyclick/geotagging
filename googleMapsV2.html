<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html  style="height:100%" xmlns="http://www.w3.org/1999/xhtml" xmlns:v="urn:schemas-microsoft-com:vml">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
    <title>Google Maps API V2</title>
    <script src="http://maps.google.com/maps?file=api&amp;v=2&amp;sensor=false&amp;key=ABQIAAAAzr2EBOXUKnm_jVnk0OJI7xSosDVG8KKPE1-m51RBrvYughuyMxQ-i1QfUnH94QxWIa6N4U6MouMmBA"
            type="text/javascript"></script>
            
    <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>        
    <script type="text/javascript">

var map;
var mgr;
var markers = [];
var routes = [];
var joinedSegments = [];
var elevator;

var yellowImg = "./icons/marker-yellow.png";
var yellowMarker = new GIcon(G_DEFAULT_ICON);
yellowMarker.image = yellowImg;
yellowMarker.iconSize = new GSize(18, 32);

var defaultImg = "./icons/marker-red.png";
var defaultMarker = new GIcon(G_DEFAULT_ICON);
defaultMarker.image = defaultImg;
defaultMarker.iconSize = new GSize(18, 32);


//// copyright /////
var copyOSM = new GCopyrightCollection("OpenStreetMap");

//// VRSTVA RELIEF /////
	var tl = new GTileLayer(null, null, null, { tileUrlTemplate:'http://services.tmapserver.cz/tiles/gm/sum/{Z}/{X}/{Y}.png'});
	tl.minResolution = function() { return 7; };
	tl.maxResolution = function() { return 15; };
	tl.isPng = function() { return true; };
	tl.getOpacity = function() { return .8; }
	tl.getCopyright = function() { return ""; }
	
	var relief = new GTileLayerOverlay(tl);
	
//// OSM MAPNIK /////
var tilesMapnik     = new GTileLayer(copyOSM, 1, 18, {tileUrlTemplate: 'http://tile.openstreetmap.org/{Z}/{X}/{Y}.png'});
var mapMapnik     = new GMapType([tilesMapnik], G_NORMAL_MAP.getProjection(), "OSM Mapnik");

//// OSM CYKLOMAPA /////
var tilesCycle = new GTileLayer(copyOSM, 1, 18, {tileUrlTemplate: 'http://c.andy.sandbox.cloudmade.com/tiles/cycle/{Z}/{X}/{Y}.png'});
var mapCycle = new GMapType([tilesCycle], G_NORMAL_MAP.getProjection(), "OSM Cyklomapa");

//// CYKLOTURISTICKA /////
var tilesTuristCyklo = new GTileLayer();
tilesTuristCyklo.getTileUrl = function(coord, zoom) {
	return "http://services.ezekiel-ngx.tmapserver.cz/tiles/gm/shc/" + zoom +(zoom > 12 ? "c" : "")+ "/" + coord.x + "/" + coord.y + ".png";
};
tilesTuristCyklo.minResolution = function() { return 1; };
tilesTuristCyklo.maxResolution = function() { return 15; };	
tilesTuristCyklo.isPng = function() { return true; };
tilesTuristCyklo.getOpacity = function() { return 1.0; }
tilesTuristCyklo.getCopyright = function() { return "©SHOCart"; }

var mapTuristCyklo = new GMapType([tilesTuristCyklo], G_NORMAL_MAP.getProjection(), "Cyklo-turistická mapa", {errorMessage:null});
mapTuristCyklo.getErrorMessage = function() { return "Pro toto přiblížení není k dispozici mapový podklad."; };

function initialize() {
  if (GBrowserIsCompatible()) {
	  
	map = new GMap2(document.getElementById("map_canvas"));
	elevator = new google.maps.ElevationService();
		  //////////////////
	map.addMapType(mapMapnik);
	map.addMapType(mapCycle);
    map.addMapType(mapTuristCyklo);
    map.setMapType(mapMapnik);

	//////////////////////////////////////

    map.addControl(new GLargeMapControl3D());
    map.addControl(new GScaleControl());
    map.enableScrollWheelZoom(); 	
    map.addControl(new GOverviewMapControl()  );

    map.setCenter(new GLatLng(49.5,16), 7);
    map.addOverlay(relief);
    relief.hide();
    }
}
  
//nastaveni mapoveho podkladu
function setMapType(mapType) {
	switch (mapType){
	case "ROADMAP":
		map.setMapType(G_NORMAL_MAP );
		break;
	case "TERRAIN":
		map.setMapType(G_PHYSICAL_MAP );
		break;
	case "SATELLITE":
		map.setMapType(G_SATELLITE_MAP );
		break;	
	case "HYBRID":
		map.setMapType(G_HYBRID_MAP );
		break;	
	case "Cykloturist":
		map.setMapType(mapTuristCyklo);
		break;	
	case "OSMMapnik":
		map.setMapType(mapMapnik);
		break;	
	case "OSMCyklo":
		map.setMapType(mapCycle);
		break;	
	default:
		break;
	}
}  

function setOldMarkerPosition(id) {
	for (var i in markers) {
		if(id==markers[i].id){
			var oldPos = new GLatLng(markers[i].oldLat,markers[i].oldLng);
			markers[i].setLatLng(oldPos);
			markers[i].redraw();

		}
    }
}

function flipRelief(setVisible) {
	if (setVisible) {
		relief.show();
	} else {
		relief.hide();
	}
	return true;
}

function setNewMarkerPosition(id) {
	for (var i in markers) {

		if(id==markers[i].id){
			markers[i].oldLat = markers[i].getLatLng().lat();
			markers[i].oldLng = markers[i].getLatLng().lng();
			
			////////////////////////

			var ele = -1000;
			
			var locations = [];
			var location = new google.maps.LatLng(markers[i].getLatLng().lat(), markers[i].getLatLng().lng()); 
			locations.push(location);

			// Create a LocationElevationRequest object using the array's one value
			var positionalRequest = {
				'locations': locations
			}
		
			// Initiate the location request
			elevator.getElevationForLocations(positionalRequest, function(results, status) {
				
				if (status == google.maps.ElevationStatus.OK) {	
					
					// Retrieve the first result
					if (results[0]) {
						ele = results[0].elevation;
					}
					
				}

				mapWidget.newMarkerAdded(id, markers[i].getLatLng().lat(),markers[i].getLatLng().lng(), ele);

			});		
		}
    }
}


var idList;
var clickListener;
function settingNewMarker(iidList) {
	idList = iidList;
	map.getDragObject().setDraggableCursor("crosshair");

	clickListener = GEvent.addListener(map, 'click', function(overlay, latlng) {
      addNewMarkers(latlng);
    });
}

function endSettingNewMarker() {
	map.getDragObject().setDraggableCursor("auto");
	GEvent.removeListener(clickListener);
}


function addNewMarkers(latLng) {
	var ele = -1000;
	var locations = [];
	var location = new google.maps.LatLng(latLng.lat(), latLng.lng()); 
	locations.push(location);

	// Create a LocationElevationRequest object using the array's one value
	var positionalRequest = {
		'locations': locations
	}

	// Initiate the location request
	elevator.getElevationForLocations(positionalRequest, function(results, status) {
		if (status == google.maps.ElevationStatus.OK) {	
			// Retrieve the first result
			if (results[0]) {
				ele = results[0].elevation;
			}
		}
		
		for (var i = 0; i< idList.length; i=i+1)
		{
			addMarker(latLng.lat(), latLng.lng(), idList[i], 1);
			markerClicked(idList[i], 1);

			mapWidget.newMarkerAdded(idList[i], latLng.lat(), latLng.lng(), ele);
		}
	});
}



function addMarker(lat, lon, iid, isVisible) {
	var location = new GLatLng(lat, lon); 
	for (i in markers) {
		if(iid==markers[i].id){
			if(lat >90 || lat > 90 || lon < -180 || lon > 180)
			{
				markers[i].setMap(null);
				markers.splice(i,1);
				return;
			}
			markers[i].setLatLng(location);
			markers[i].oldLat = lat;
			markers[i].oldLng = lon;

			if(isVisible){	
				markers[i].redraw();
			}
			return;
		}
    }
   	if(lat >90 || lat > 90 || lon < -180 || lon > 180)
		return;	
		
	var markerOptions = {
		draggable:true,
		icon: defaultMarker,
		position: location,
		zIndexProcess:importanceOrder,
		id:iid
	}; 

	var marker = new GMarker(location, markerOptions);
	
	marker.oldLat = lat;
	marker.oldLng = lon;

	marker.isSelected = 0;
	marker.zindex = 0;

	if(isVisible)
		map.addOverlay(marker);
	markers.push(marker);

	GEvent.bind(marker, 'click',this, function() {
		mapWidget.markerClicked(marker.id);
	});

	GEvent.addListener(marker, 'dragstart',function() {
		mapWidget.markerClicked(marker.id);
		
	});	
	GEvent.addListener(marker, 'dragend',function() {
		mapWidget.markerDragged(marker.id, marker.getLatLng().lat(), marker.getLatLng().lng());
	});	
}

function importanceOrder (marker,b) { 
        return marker.zindex; 
}

function changeRouteOpacity(id, value) {
	for (var i in routes) {
		if(id==routes[i].id)
			routes[i].setStrokeStyle({opacity: value});
    }
	for (var i in joinedSegments) {
		if(id==joinedSegments[i].id)
			joinedSegments[i].setStrokeStyle({opacity: value});
    }
}

function lineWidthChanged(id, value) {
	for (var i in routes) {
		if(id==routes[i].id){
			routes[i].setStrokeStyle({weight: value});
		}			
    }
 	for (var i in joinedSegments) {
		if(id==joinedSegments[i].id)
			joinedSegments[i].setStrokeStyle({weight: value});
    }
}
function changeRouteColor(id, value) {
	for (var i in routes) {
		if(id==routes[i].id)
			routes[i].setStrokeStyle({color: value});
    }
    for (var i in joinedSegments) {
		if(id==joinedSegments[i].id)
			joinedSegments[i].setStrokeStyle({color: value});
    }
}
function setJoinSegments(setVisible) {
	for (var i in joinedSegments) {
		if(setVisible)
			map.addOverlay(joinedSegments[i]);
		else
			map.removeOverlay(joinedSegments[i]);
    }
}

function addRoute(routeCoordinatesList, iid, isVisible, color, isValid) {
	path = [];
	routeCoordinatesList.forEach(function(e) {
		path.push(new GLatLng(e[0], e[1]));
	});
	var route = new GPolyline(
		path,
		color,
		3,
		1.0
	);
	route.id = iid;
	if(isVisible)
		map.addOverlay(route);

	var bounds = route.getBounds();
	map.setCenter(bounds.getCenter(),map.getBoundsZoomLevel(bounds));

	if(isValid)
		routes.push(route);
	else
		joinedSegments.push(route);
}


function centerInBounds(fitMarkers, fitRoutes){
	if(markers.length == 0 && routes.length == 0)
		return;
	
	var bounds = new GLatLngBounds;
	if(fitMarkers)
	{
		for (i in markers) {
			bounds.extend(markers[i].getPoint());
		}
	}
	if(fitRoutes)
	{
		for (i in routes) {
			bounds.extend(routes[i].getBounds().getSouthWest());
			bounds.extend(routes[i].getBounds().getNorthEast());
		}
	}
	map.setCenter(bounds.getCenter(),map.getBoundsZoomLevel(bounds));
	//map.zoomOut();
}


function markerSelected(isSelected, i, markersVisible){
	if(isSelected)
	{
		map.setCenter(markers[i].getPoint());
		markers[i].isSelected = 1;
	    markers[i].zindex = 1;
	    map.removeOverlay(markers[i]);
	    map.addOverlay(markers[i]);
        markers[i].setImage(yellowImg);
	}
	else
	{
		markers[i].zindex = 0;
		markers[i].setImage(defaultImg); 
		markers[i].zindex = 0; 
		markers[i].isSelected = 0;
		
        if(!markersVisible)
             map.removeOverlay(markers[i]);
	}
}

function markerClicked(id, isCtrl) {
	for (i in markers) {
         if(id==markers[i].id){
            markers[i].isSelected = 1;
            markers[i].zindex = 1;
			//map.removeOverlay(markers[i]);
			//map.addOverlay(markers[i]);
			markers[i].redraw();
			markers[i].setImage(yellowImg);
         }
         else if(!isCtrl){
            markers[i].setImage(defaultImg);
            markers[i].isSelected = 0;
            markers[i].zindex = 0;
          }
	  }
	  
}

function setMarkersVisibility(setVisible) {
	for (i in markers) {
		if(setVisible){
			map.addOverlay(markers[i]);
			if(markers[i].isSelected)
				markers[i].setImage(yellowImg);
		}
		else
		{
			if( markers[i].isSelected== 0)
				map.removeOverlay(markers[i]);
		}
	}
}

function setRoutesVisibility(setVisible) {
	for (i in routes) {
		if(setVisible)
			map.addOverlay(routes[i]);
		else
			map.removeOverlay(routes[i]);
    }
}

function deleteMarker(id) {
	for (i in markers) {
        if(id==markers[i].id){
			map.removeOverlay(markers[i]);
            markers.splice(i,1);
            break;
        }
    }
}

function deleteRoute(id) {
	for(var i=routes.length - 1; i>=0; i--) {
        if(id==routes[i].id){
			map.removeOverlay(routes[i]);
            routes.splice(i,1);
        }
    }
	for(var i=joinedSegments.length - 1; i>=0; i--) {
		if(id==joinedSegments[i].id) {
			map.removeOverlay(joinedSegments[i]);
			joinedSegments.splice(i,1);
		}
    }
}

</script>
  </head>
  <body style="margin: 0px; width: 100%; height: 100%" onload="initialize()" onunload="GUnload()">
    <div  id="map_canvas" style="width: 100%; height: 100%"></div>
  </body>
</html>

