<!DOCTYPE html><html><head>  
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Google Maps API V3</title>
<link href="http://code.google.com/apis/maps/documentation/javascript/examples/standard.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>

<script type="text/javascript">
	
var osmMapTypeMapnik = new google.maps.ImageMapType({
	getTileUrl: function(coord, zoom) {
		return "http://tile.openstreetmap.org/" +
		zoom + "/" + coord.x + "/" + coord.y + ".png";
	},
	tileSize: new google.maps.Size(256, 256),
	isPng: true,
	alt: "OpenStreetMapMapnik layer",
	name: "OSM-Mapnik",
	maxZoom: 18
});

var osmMapTypeCycleMap = new google.maps.ImageMapType({
	getTileUrl: function(coord, zoom) {
		/*alert("ht.org/" +
		zoom + "/" + coord.x + "/" + coord.y + ".png");*/
		return "http://c.andy.sandbox.cloudmade.com/tiles/cycle/" +
		zoom + "/" + coord.x + "/" + coord.y + ".png";
	},
	
	tileSize: new google.maps.Size(256, 256),
	isPng: true,
	alt: "OpenStreetMapCycle layer",
	name: "OSM-Cyklomapa",
	maxZoom: 18
});

var mapTuristCyklo = new google.maps.ImageMapType({
	getTileUrl: function(coord, zoom) {
		return "http://services.ezekiel-ngx.tmapserver.cz/tiles/gm/shc/" +
		zoom +(zoom > 12 ? "c" : "")+ "/" + coord.x + "/" + coord.y + ".png";
	},
	tileSize: new google.maps.Size(256, 256),
	isPng: true,
	alt: "CykloTurist layer",
	name: "Cyklo-turistická mapa",
	maxZoom: 15,
	minZoom: 7
	//errorMessage = function() { return "Pro toto přiblížení není k dispozici mapový podklad."; };
	//minZoom: 1	

	/*var mapTuristCyklo = new GMapType([tilesTuristCyklo], G_NORMAL_MAP.getProjection(), "MAPTC", {errorMessage:null});
	mapTuristCyklo.getErrorMessage = function() { return "Pro toto přiblížení není k dispozici mapový podklad."; };*/
});

var mapTuristCykloRelief = new google.maps.ImageMapType({
	getTileUrl: function(coord, zoom) {
	/////// mozna nacist do skriteho obrayku, testovat onLoad...jak vracet?
		return "http://services.tmapserver.cz/tiles/gm/sum/" +
		zoom + "/" + coord.x + "/" + coord.y + ".png";
		//alert("http://mapserver.mapy.cz/relief-l/" + zoom + "_" +  coord.x + "_" + coord.y);
		//return "http://mapserver.mapy.cz/relief-l/" + zoom + "_" +  coord.x + "_" + coord.y //13_8668000_81b0000
	},
	tileSize: new google.maps.Size(256, 256),
	isPng: true,
	alt: "CykloTuristRelief layer",
	name: "Cyklo-turistická mapa - relief",
	opacity: .8,
	maxZoom: 15,
	minZoom: 7
});

//var mapTuristCykloMap = new google.maps.MapType([tilesTuristCyklo], G_NORMAL_MAP.getProjection(), "Cyklo-turistická mapa", {errorMessage:null});
/*
var reliefLayer = new google.maps.TileLayer(null, null, null, {opacity:0.5, isPng:true, tileUrlTemplate:'http://services.tmapserver.cz/tiles/gm/sum/{Z}/{X}/{Y}.png'});
reliefLayer.minResolution = function() { return 7; };
	tl.maxResolution = function() { return 15; };
	tl.isPng = function() { return true; };
	tl.getOpacity = function() { return 1; }
	tl.getCopyright = function() { return ""; }
	var tlo = new GTileLayerOverlay(tl, null);
	map.addOverlay(tlo);*/

///////////////////
//var mapTCRelief = new google.maps.ImageMapType({
/*var tl = new GTileLayer(null, null, null, {opacity:1, isPng:true, tileUrlTemplate:'http://services.tmapserver.cz/tiles/gm/sum/{Z}/{X}/{Y}.png'});
			        tl.minResolution = function() { return 7; };
			        tl.maxResolution = function() { return 15; };
			        tl.isPng = function() { return true; };
			        tl.getOpacity = function() { return 1; }
			        tl.getCopyright = function() { return ""; }

					var tlo = new GTileLayerOverlay(tl, null);
					
					return tlo;

       					map.addOverlay(tlo);

       					//map.removeOverlay(tlo);*/



var map;
var markers = [];
var routes = [];
var joinedSegments = [];
var clickListener;
//var yellowMarker = "http://esa.ilmari.googlepages.com/markeryellow.png";
var yellowMarker = "./icons/marker-yellow.png";
var defaultMarker = "./icons/marker-red.png";
var elevator;
function initialize() {
	//var myLatlng = new google.maps.LatLng(0,0);
	
	// Create ElevationService
	elevator = new google.maps.ElevationService();
	
	var myLatlng = new google.maps.LatLng(49.5,16);

	var myOptions = {
		zoom: 7,
		center: myLatlng,
		mapTypeId: 'OSMMapnik',
		////mapTypeId: 'OSMCycleMap',

		overviewMapControl: true, 
		overviewMapControlOptions: {opened: true},
		mapTypeControlOptions: {
  	  	  	 // mapTypeIds: ['CykloTurist', 'OSMMapnik', 'OSMCycleMap' , google.maps.MapTypeId.ROADMAP, 
  	  	  	 // google.maps.MapTypeId.HYBRID, google.maps.MapTypeId.SATELLITE,  google.maps.MapTypeId.TERRAIN],
  	  	  	  //style: google.maps.MapTypeControlStyle.DROPDOWN_MENU
  	  	  	  mapTypeIds: []
		}
	}

	//alert(document.getElementById(google.maps.MapTypeId.ROADMAP).name);
	map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);
	map.mapTypes.set('OSMMapnik',osmMapTypeMapnik);
	//map.mapTypes.set('OSMOsmarend',osmMapTypeOsmarend);
	map.mapTypes.set('OSMCycleMap',osmMapTypeCycleMap);
	map.mapTypes.set('CykloTurist',mapTuristCyklo);
}

function setMapType(mapType) {
	switch (mapType){
	case "ROADMAP":
		map.setMapTypeId(google.maps.MapTypeId.ROADMAP);
		break;
	case "TERRAIN":
		map.setMapTypeId(google.maps.MapTypeId.TERRAIN);
		break;
	case "SATELLITE":
		map.setMapTypeId(google.maps.MapTypeId.SATELLITE);
		break;	
	case "HYBRID":
		map.setMapTypeId(google.maps.MapTypeId.HYBRID);
		break;	
	case "Cykloturist":
		map.setMapTypeId('CykloTurist');
		break;	
	case "OSMMapnik":
		map.setMapTypeId('OSMMapnik');
		break;	
	case "OSMCyklo":
		map.setMapTypeId('OSMCycleMap');
		break;	
	default:
		break;
	}
}


function flipRelief(setVisible) {
	if (setVisible) {
		map.overlayMapTypes.insertAt(0, mapTuristCykloRelief);
	} else {
		map.overlayMapTypes.removeAt(0);
	}
	return true;
}

function setOldMarkerPosition(id) {
	for (var i in markers) {
		if(id==markers[i].id){
			markers[i].position = markers[i].oldPosition;
			markers[i].setMap(map);
		}
    }
}

function setNewMarkerPosition(id) {
	for (var markerIdx in markers) {
		if(id==markers[markerIdx].id){
			markers[markerIdx].oldPosition = markers[markerIdx].position;

			var newLat = markers[markerIdx].position.lat();
			var newLng = markers[markerIdx].position.lng();

			//markers[markerIdx].setMap(map);
			//return markers[markerIdx].position;
			
			////////////////////////

			var ele = -1000;
			var locations = [];
			locations.push(markers[markerIdx].getPosition());

			// Create a LocationElevationRequest object using the array's one value
			var positionalRequest = {
				'locations': locations
			}
			// Initiate the location request
			elevator.getElevationForLocations(positionalRequest, function(results, status) {
				if (status == google.maps.ElevationStatus.OK) {	
					// Retrieve the first result
					if (results[0]) {
						ele = results[0].elevation;
					}
				}
//				alert(newLat+ ", " +newLng + " != " + markers[markerIdx].position.lat()+ " " + markers[markerIdx].position.lng() + " " + ele);

				mapWidget.newMarkerAdded(id, newLat, newLng, ele);
			});
		}
    }
    //return [markers[markerIdx].position.lat(),markers[markerIdx].position.lng(), ele];
}


var idList;
function settingNewMarker(iidList) {
	idList = iidList;
	map.draggableCursor = 'crosshair';
	clickListener = google.maps.event.addListener(map, 'click', function(event) {
      addNewMarkers(event.latLng);
    });

}
function endSettingNewMarker() {
	map.draggableCursor = 'auto';
	google.maps.event.removeListener(clickListener);
}


function addNewMarkers(LatLng) {

	var ele = -1000;
	var locations = [];
	locations.push(LatLng);

	// Create a LocationElevationRequest object using the array's one value
	var positionalRequest = {
		'locations': locations
	}
	
	// Initiate the location request
	elevator.getElevationForLocations(positionalRequest, function(results, status) {
		if (status == google.maps.ElevationStatus.OK) {	
			// Retrieve the first result
			if (results[0]) {
				ele = results[0].elevation;
			}
		}
		
		for (var i = 0; i< idList.length; i=i+1)
		{
			addMarker(LatLng.lat(), LatLng.lng(), idList[i], 1);
			markerClicked(idList[i], 1);
			mapWidget.newMarkerAdded(idList[i], LatLng.lat(), LatLng.lng(), ele);

		}
	});

}

function addMarker(lat, lon, iid, isVisible) {
	var location = new google.maps.LatLng(lat, lon); 
	for (var i in markers) {
		if(iid==markers[i].id){
			if(lat >90 || lat > 90 || lon < -180 || lon > 180)
			{
				markers[i].setMap(null);
				markers.splice(i,1);
				return;
			}
			
			markers[i].position = location;
			markers[i].oldPosition = location;
			if(isVisible)
				markers[i].setMap(map);
			//centerInBounds(1,0);
			return;
		}
    }
    
   	if(lat >90 || lat > 90 || lon < -180 || lon > 180)
		return;	
		
	var marker = new google.maps.Marker({
		draggable:true,
		icon: defaultMarker,
		position: location,
		oldPosition: location,
		//title:"Muj puntik!",
		id:iid
	});

	if(isVisible)
		marker.setMap(map);
	markers.push(marker);
	google.maps.event.addListener(marker, 'click',function() {
		mapWidget.markerClicked(marker.id);
	});
	google.maps.event.addListener(marker, 'dragstart',function() {
		mapWidget.markerClicked(marker.id);
	});	
	google.maps.event.addListener(marker, 'dragend',function() {
		mapWidget.markerDragged(marker.id, marker.position.lat(), marker.position.lng());
	});	

	//centerInBounds(1,0);
}
function changeRouteOpacity(id, value) {
	for (var i in routes) {
		if(id==routes[i].id)
			routes[i].setOptions({strokeOpacity: value});
    }
	for (var i in joinedSegments) {
		if(id==joinedSegments[i].id)
			joinedSegments[i].setOptions({strokeOpacity: value});
    }
}
function lineWidthChanged(id, value) {
	for (var i in routes) {
		if(id==routes[i].id)
			routes[i].setOptions({strokeWeight: value});
    }
 	for (var i in joinedSegments) {
		if(id==joinedSegments[i].id)
			joinedSegments[i].setOptions({strokeWeight: value});
    }
}

function changeRouteColor(id, value) {
	for (var i in routes) {
		if(id==routes[i].id)
			routes[i].setOptions({strokeColor: value});
    }
    for (var i in joinedSegments) {
		if(id==joinedSegments[i].id)
			joinedSegments[i].setOptions({strokeColor: value});
    }
}
function setJoinSegments(setVisible) {
	for (var i in joinedSegments) {
		if(setVisible)
			joinedSegments[i].setMap(map);
		else
			joinedSegments[i].setMap(null);
    }
   // alert(setVisible);
}

//////////

function addRoute(routeCoordinatesList, iid, isVisible, color, isValid) {
	path= [];
	routeCoordinatesList.forEach(function(e) {
		path.push(new google.maps.LatLng(e[0], e[1]));
	});
	
	var route = new google.maps.Polyline({
		path: path,
		strokeColor: color,
		strokeOpacity: 1.0,
		strokeWeight: 3,
		id: iid
	});
	if(isVisible)
		route.setMap(map);

	var bounds = new google.maps.LatLngBounds;
	for (i in path) {
		bounds.extend(path[i]);
	}
	map.fitBounds(bounds);
	//map.panToBounds(bounds);
	if(isValid)
		routes.push(route);
	else
		joinedSegments.push(route);
}
function centerInBounds(fitMarkers, fitRoutes){

	if(markers.length == 0 && routes.length == 0)
	{
		/*var myLatlng = new google.maps.LatLng(0,0);
		var zoom = 1;
		map.setCenter(myLatLng);
		map.setZoom = zoom;*/
		return;
	}
		
	var bounds = new google.maps.LatLngBounds;
	if(fitMarkers)
	{
		for (i in markers) {
			bounds.extend(markers[i].position);
		}
	}
	if(fitRoutes)
	{
		for (i in routes) {
			 routes[i].getPath().forEach(function(e) {
				bounds.extend(e);
			});
		}
	}
	map.fitBounds(bounds);
	//map.panToBounds(bounds);
}
function markerSelected(isSelected, i, markersVisible){
	if(isSelected)
	{
		//map.setCenter(markers[i].position);
		map.panTo(markers[i].position);
	    markers[i].setIcon(yellowMarker);
		markers[i].setZIndex(1);
		if(!markersVisible)
              markers[i].setMap(map);
	}
	else
	{    
		markers[i].setIcon(defaultMarker);
		markers[i].setZIndex(0);
        if(!markersVisible)
              markers[i].setMap(null);
	}
}
function markerClicked(id, isCtrl) {
	for (var i in markers) {
         if(id==markers[i].id){
            markers[i].setIcon(yellowMarker);
            markers[i].setZIndex(1);
         }
         else if(!isCtrl){
            markers[i].setIcon(defaultMarker);
            markers[i].setZIndex(0);
          }
	  }
}
function setMarkersVisibility(setVisible) {
	for (var i in markers) {
		if(setVisible)
			markers[i].setMap(map);
		else
		{
			if( markers[i].icon == defaultMarker)
				markers[i].setMap(null);
		}	
    }
}
function setRoutesVisibility(setVisible) {
	for (var i in routes) {
		if(setVisible)
			routes[i].setMap(map);
		else
			routes[i].setMap(null);
    }
}

function deleteMarker(id) {
	for (var i in markers) {
        if(id==markers[i].id){
            markers[i].setMap(null);
            markers.splice(i,1);
            break;
        }
    }
}

function deleteRoute(id) {
	for(var i=routes.length - 1; i>=0; i--) {
        if(id==routes[i].id){
            routes[i].setMap(null);
            routes.splice(i,1);
        }
    }
	for(var i=joinedSegments.length - 1; i>=0; i--) {
		if(id==joinedSegments[i].id) {
			joinedSegments[i].setMap(null);
			joinedSegments.splice(i,1);
		}
    }
}

</script>
</head>
 <body onload="initialize()">
  <div id="map_canvas" style="width: 100%; height: 100%">
  </div>
</body>
</html>
